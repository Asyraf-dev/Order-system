<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Menu Admin — Restoran Ayam Gepuk Ngences</title>
  <style>
    :root{
      --accent:#0b74de;
      --muted:#6b7280;
      --card:#fff;
      --bg:#f6f8fb;
      --danger:#ef4444;
      --success:#16a34a;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: Inter, "Segoe UI", Roboto, system-ui, -apple-system, Arial;
      background:var(--bg);
      color:#0f172a;
      padding:16px;
    }

    header{display:flex;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:16px}
    header h1{margin:0;font-size:1.25rem}
    header p{margin:0;color:var(--muted);font-size:0.95rem}

    .container{display:grid;grid-template-columns: 1fr; gap:12px; max-width:1100px;margin:0 auto;}
    @media(min-width:900px){ .container{grid-template-columns: 360px 1fr} }

    .card{background:var(--card); border-radius:12px; padding:12px; box-shadow:0 6px 18px rgba(12,18,30,0.04); border:1px solid #eef2f6}
    .card h3{margin:0 0 8px 0}

    .form-row{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
    label{font-size:13px;color:var(--muted)}
    input[type="text"], input[type="number"], select, textarea{
      width:100%; padding:8px 10px; border-radius:8px; border:1px solid #e6e9ee; font-size:14px;
      background:white;
    }
    textarea{min-height:90px; resize:vertical}
    .btn{display:inline-block;padding:8px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:700}
    .btn-primary{background:var(--accent);color:white}
    .btn-ghost{background:transparent;border:1px solid #dbe6f6;color:var(--accent)}
    .btn-danger{background:var(--danger);color:white}
    .muted{color:var(--muted);font-size:13px}

    #items-list{display:flex;flex-direction:column;gap:10px;max-height:70vh;overflow:auto;padding-right:6px}
    .item-row{display:flex;gap:12px;align-items:flex-start;padding:10px;border-radius:10px;border:1px solid #eef2f6;background:linear-gradient(180deg,#fff,#fbfdff)}
    .item-thumb{width:84px;height:64px;border-radius:8px;object-fit:cover;border:1px solid #f0f2f5;flex-shrink:0}
    .item-main{flex:1;display:flex;flex-direction:column;gap:6px}
    .item-title{font-weight:700;font-size:15px}
    .item-meta{color:var(--muted);font-size:13px}
    .item-controls{display:flex;gap:8px;align-items:center;margin-top:6px;flex-wrap:wrap}

    .toggle-switch{display:inline-flex;align-items:center;gap:8px}
    .switch{width:44px;height:24px;background:#e6eefc;border-radius:999px;position:relative;cursor:pointer}
    .switch .knob{position:absolute;width:18px;height:18px;border-radius:50%;top:3px;left:3px;background:white;box-shadow:0 4px 8px rgba(2,6,23,0.06);transition:all .18s}
    .switch.on{background:var(--success)}
    .switch.on .knob{left:23px}

    .small-muted{font-size:12px;color:var(--muted)}
    .danger-small{background:transparent;border:1px solid rgba(239,68,68,0.12);color:var(--danger);padding:6px 8px;border-radius:8px}

    /* Category availability UI */
    .category-list{display:flex;flex-direction:column;gap:8px}
    .category-row{display:flex;align-items:center;justify-content:space-between;padding:8px;border-radius:8px;border:1px solid #eef2f6;background:#fff}
    .category-name{font-weight:700;color:#0f172a}
    .category-note{font-size:12px;color:var(--muted)}

    #notice{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;padding:10px 14px;border-radius:10px;background:#111827;color:white;display:none;z-index:9999}
  </style>
</head>
<body>

  <header>
    <div>
      <h1>Menu Admin</h1>
      <p class="muted">Add / Edit / Toggle availability of menu items in Firebase</p>
    </div>
  </header>

  <div class="container">
    <!-- left: add/edit form -->
    <div class="card">
      <h3 id="form-title">Add New Menu Item</h3>
      <div style="margin-top:8px">
        <div class="form-row">
          <div style="flex:1">
            <label>Item name</label>
            <input id="name" type="text" placeholder="e.g. Original Peha (Sambal Kacang)">
          </div>
        </div>

        <div class="form-row">
          <div style="width:140px">
            <label>Price (RM)</label>
            <input id="price" type="number" step="0.01" min="0" value="0.00">
          </div>
          <div style="flex:1">
            <label>Category</label>
            <select id="category">
              <option value="food">Food</option>
              <option value="Side Dish">Side Dish</option>
              <option value="Air Panas">Air Panas</option>
              <option value="Air Sejuk">Air Sejuk</option>
              <option value="Little Ngences Food">Little Ngences Food</option>
              <option value="Little Ngences Drink">Little Ngences Drink</option>
              <option value="Others">Others</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div style="flex:1">
            <label>Image URL (optional)</label>
            <input id="image" type="text" placeholder="https://...jpg">
          </div>
        </div>

        <div class="form-row">
          <div style="flex:1">
            <label>Add-ons (one per line, format: name:price)</label>
            <textarea id="addons" placeholder="Nasi Tambah:2.00&#10;Tempe Tambah:1.50"></textarea>
            <div class="muted" style="margin-top:6px">Avoid characters . # $ / [ ]</div>
          </div>
        </div>

        <div style="display:flex;gap:8px;margin-top:10px">
          <button id="save-btn" class="btn btn-primary">Save</button>
          <button id="reset-btn" class="btn btn-ghost">Reset</button>
          <button id="delete-btn" class="btn btn-danger" style="display:none">Delete</button>
        </div>
      </div>
    </div>

    <!-- right: category availability + items list -->
    <div class="card">
      <h3>Menu Items</h3>

      <!-- Category Availability panel (NEW) -->
      <div class="card" style="margin-bottom:12px;padding:10px">
        <h4 style="margin:0 0 8px 0;color:var(--accent)">Category Availability</h4>
        <div id="category-availability" class="category-list">
          <!-- dynamically populated -->
        </div>
        <div class="muted" style="margin-top:8px">Toggles are saved — changing a category toggle will set all items in that category to available/unavailable.</div>
      </div>

      <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
        <label for="filter" style="font-size:14px;color:var(--muted)">Filter:</label>
        <select id="filter" style="padding:6px 8px;border-radius:8px;border:1px solid #e5e7eb;font-size:14px">
          <option value="all">All</option>
          <option value="food">Food</option>
          <option value="Side Dish">Side Dish</option>
          <option value="Air Panas">Air Panas</option>
          <option value="Air Sejuk">Air Sejuk</option>
          <option value="Little Ngences Food">Little Ngences Food</option>
          <option value="Little Ngences Drink">Little Ngences Drink</option>
          <option value="Others">Others</option>
        </select>
      </div>

      <div id="items-list" aria-live="polite"></div>
    </div>
  </div>

  <div id="notice"></div>

  <!-- Firebase + script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import {
      getDatabase, ref, onValue, push, set, update, remove, get
    } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAUO2ZoVhSFEtAyJAP5r5zxu3kGqoIAyQ4",
      authDomain: "ordersystem-d710a.firebaseapp.com",
      databaseURL: "https://ordersystem-d710a-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "ordersystem-d710a",
      storageBucket: "ordersystem-d710a.firebasestorage.app",
      messagingSenderId: "741444965493",
      appId: "1:741444965493:web:9991535a9105035c80943c",
      measurementId: "G-4P6YQDH0LL"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const itemsRef = ref(db, "menuItems");
    const categoryStatusRef = ref(db, "categoryStatus"); // NEW: store per-category availability

    const categories = [
      "food",
      "Side Dish",
      "Air Panas",
      "Air Sejuk",
      "Little Ngences Food",
      "Little Ngences Drink",
      "Others"
    ];

    const itemsList = document.getElementById("items-list");
    const nameEl = document.getElementById("name");
    const priceEl = document.getElementById("price");
    const categoryEl = document.getElementById("category");
    const imageEl = document.getElementById("image");
    const addonsEl = document.getElementById("addons");
    const saveBtn = document.getElementById("save-btn");
    const resetBtn = document.getElementById("reset-btn");
    const deleteBtn = document.getElementById("delete-btn");
    const formTitle = document.getElementById("form-title");
    const notice = document.getElementById("notice");
    const filterEl = document.getElementById("filter");
    const categoryAvailabilityEl = document.getElementById("category-availability");

    let editingId = null;
    let currentCategoryStatus = {}; // cached from Firebase

    function showNotice(msg,time=2500){
      notice.innerText = msg;
      notice.style.display = "block";
      setTimeout(()=> notice.style.display="none",time);
    }

    function sanitizeKey(k){
      if(!k) return "";
      return k.replace(/[.#$\/\[\]]/g,'').trim().replace(/\s+/g,'_');
    }

    function parseAddons(text){
      const out = {};
      const lines = text.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
      for(const line of lines){
        const parts = line.split(/[:\-\|]/).map(p => p.trim());
        if(parts.length >= 2){
          const label = parts[0]; // keep as typed
          let price = parseFloat(parts[1]);
          if(isNaN(price)) price = 0;
          out[label] = Number(price);
        } else {
          out[line] = 0; // no price, still keep raw text
        }
      }
      return out;
    }

    function addonsToText(obj){
      if(!obj) return "";
      return Object.entries(obj)
        .map(([label, price]) => `${label}:${Number(price).toFixed(2)}`)
        .join("\n");
    }

    function fillForm(id,data){
      editingId=id;
      formTitle.innerText=`Edit menu: ${data.name||id}`;
      nameEl.value=data.name||"";
      priceEl.value=Number(data.price||0).toFixed(2);
      categoryEl.value=data.category||"food";
      imageEl.value=data.image||"";
      addonsEl.value=addonsToText(data.addOns||{});
      deleteBtn.style.display="inline-block";
      saveBtn.innerText="Update";
      window.scrollTo({top:0,behavior:"smooth"});
    }

    function resetForm(){
      editingId=null;
      formTitle.innerText="Add New Menu Item";
      nameEl.value="";
      priceEl.value="0.00";
      categoryEl.value="food";
      imageEl.value="";
      addonsEl.value="";
      deleteBtn.style.display="none";
      saveBtn.innerText="Save";
    }

    function renderItemRow(id,data){
      const row=document.createElement("div");
      row.className="item-row";
      row.dataset.id=id;

      const img=document.createElement("img");
      img.className="item-thumb";
      img.src=data.image||"https://via.placeholder.com/160x120?text=No+Image";
      img.alt=data.name||id;

      const main=document.createElement("div");
      main.className="item-main";

      const title=document.createElement("div");
      title.className="item-title";
      title.innerText=data.name||"Untitled";

      const meta=document.createElement("div");
      meta.className="item-meta";
      meta.innerText=`RM ${Number(data.price||0).toFixed(2)} • ${data.category||"Others"}`;

      const addonsBrief = document.createElement("div");
      addonsBrief.className = "small-muted";

      if (data.addOns) {
        const addonList = Object.entries(data.addOns).map(
          ([label, price]) => `${label} (RM${Number(price).toFixed(2)})`
        );
        addonsBrief.innerText = addonList.length
          ? `Add-ons: ${addonList.join(", ")}`
          : "";
      }

      const controls=document.createElement("div");
      controls.className="item-controls";

      const toggleWrap=document.createElement("label");
      toggleWrap.className="toggle-switch";
      const switchEl=document.createElement("span");
      switchEl.className="switch "+(data.visible!==false?"on":"");
      switchEl.title=data.visible!==false?"Available":"Unavailable";
      const knob=document.createElement("span");knob.className="knob";
      switchEl.appendChild(knob);
      toggleWrap.appendChild(switchEl);
      const availLabel=document.createElement("span");availLabel.className="small-muted";
      availLabel.innerText=data.visible!==false?"Available":"Unavailable";
      toggleWrap.appendChild(availLabel);

      const editBtn=document.createElement("button");
      editBtn.className="btn btn-ghost";
      editBtn.innerText="Edit";
      editBtn.addEventListener("click",()=>fillForm(id,data));

      const delBtn=document.createElement("button");
      delBtn.className="danger-small";
      delBtn.innerText="Delete";
      delBtn.addEventListener("click",async (e)=>{
        e.stopPropagation();
        if(!confirm("Delete this menu item?")) return;
        try{ await remove(ref(db,`menuItems/${id}`)); showNotice("Deleted"); }
        catch(err){ console.error(err); showNotice("Failed to delete"); }
      });

      controls.appendChild(toggleWrap);
      controls.appendChild(editBtn);
      controls.appendChild(delBtn);

      row.addEventListener("click",()=>fillForm(id,data));

      switchEl.addEventListener("click",async (e)=>{
        e.stopPropagation();
        const newVisible=!(data.visible!==false);
        try{
          await update(ref(db,`menuItems/${id}`),{visible:newVisible});
          showNotice(newVisible?"Made available":"Marked unavailable");
        }catch(err){ console.error(err); showNotice("Update failed"); }
      });

      main.appendChild(title);
      main.appendChild(meta);
      if(addonsBrief.innerText) main.appendChild(addonsBrief);
      main.appendChild(controls);

      row.appendChild(img);
      row.appendChild(main);

      return row;
    }

    function renderItems(data){
      itemsList.innerHTML="";
      const grouped={};
      Object.keys(data).forEach(id=>{
        const item=data[id]||{};
        const category=item.category||"Others";
        if(!grouped[category]) grouped[category]=[];
        grouped[category].push({id,item});
      });
      const categoryOrder=categories;
      const selected=filterEl.value;
      categoryOrder.forEach(cat=>{
        if(grouped[cat]){
          if(selected!=="all" && selected!==cat) return;
          const header=document.createElement("h4");
          header.innerText=cat;
          header.style.margin="16px 0 8px";
          header.style.color="var(--accent)";
          header.style.borderBottom="1px solid #e5e7eb";
          header.style.paddingBottom="4px";
          // show category status next to header
          const statusSpan=document.createElement("span");
          statusSpan.style.fontSize="13px";
          statusSpan.style.marginLeft="8px";
          statusSpan.style.color="var(--muted)";
          const catStatus = currentCategoryStatus[cat];
          statusSpan.innerText = (catStatus === false) ? " (Category: Unavailable)" : " (Category: Available)";
          header.appendChild(statusSpan);

          itemsList.appendChild(header);
          grouped[cat].sort((a,b)=>(a.item.name||"").localeCompare(b.item.name||"")).forEach(({id,item})=>{
            const row=renderItemRow(id,item);
            itemsList.appendChild(row);
          });
        }
      });
    }

    // Render category availability toggles into the Category Availability panel
    function renderCategoryAvailabilityUI(){
      categoryAvailabilityEl.innerHTML = "";
      categories.forEach(cat=>{
        const row = document.createElement("div");
        row.className = "category-row";

        const left = document.createElement("div");
        left.style.display = "flex";
        left.style.flexDirection = "column";
        left.style.gap = "2px";

        const name = document.createElement("div");
        name.className = "category-name";
        name.innerText = cat;

        const note = document.createElement("div");
        note.className = "category-note";
        note.innerText = currentCategoryStatus[cat] === false ? "Currently: Unavailable — items in this category are hidden" : "Currently: Available — items in this category are visible";

        left.appendChild(name);
        left.appendChild(note);

        const toggleWrap = document.createElement("div");
        toggleWrap.className = "toggle-switch";
        const switchEl = document.createElement("span");
        switchEl.className = "switch " + (currentCategoryStatus[cat] !== false ? "on" : "");
        switchEl.title = currentCategoryStatus[cat] !== false ? "Category available" : "Category unavailable";
        const knob = document.createElement("span"); knob.className = "knob";
        switchEl.appendChild(knob);
        toggleWrap.appendChild(switchEl);

        // When category toggle is clicked:
        switchEl.addEventListener("click", async (e) => {
          e.stopPropagation();
          // compute new status (if undefined or true => set false; if false => set true)
          const newStatus = !(currentCategoryStatus[cat] !== false);
          // update categoryStatus in DB and update all menuItems in that category
          try {
            // 1) set categoryStatus/{cat} = newStatus
            const updates = {};
            updates[`categoryStatus/${sanitizeKey(cat)}`] = newStatus;
            // 2) set menuItems/*/visible = newStatus for items in this category
            const snap = await get(itemsRef);
            const data = snap.val() || {};
            let affected = 0;
            Object.keys(data).forEach(id => {
              const item = data[id] || {};
              if ((item.category||"") === cat) {
                updates[`menuItems/${id}/visible`] = newStatus;
                affected++;
              }
            });
            // Apply bulk update
            await update(ref(db), updates);
            showNotice(`${affected} item(s) in "${cat}" set to ${newStatus ? "available" : "unavailable"}`);
            // update local cache immediately (will also be updated by onValue listener)
            currentCategoryStatus[cat] = newStatus;
            renderCategoryAvailabilityUI();
          } catch (err) {
            console.error(err);
            showNotice("Failed to update category");
          }
        });

        row.appendChild(left);
        row.appendChild(toggleWrap);
        categoryAvailabilityEl.appendChild(row);
      });
    }

    // Listen to menu items and categoryStatus so UI stays in sync
    onValue(itemsRef, (snap) => {
      renderItems(snap.val() || {});
    });

    // Listen to categoryStatus (saved toggles)
    onValue(categoryStatusRef, (snap) => {
      // categoryStatus stored by sanitized key; map back to original category names
      const raw = snap.val() || {};
      const mapped = {};
      categories.forEach(cat => {
        const key = sanitizeKey(cat);
        if (Object.prototype.hasOwnProperty.call(raw, key)) {
          mapped[cat] = raw[key];
        } else {
          mapped[cat] = true; // default to available if not set
        }
      });
      currentCategoryStatus = mapped;
      renderCategoryAvailabilityUI();

      // also re-render items header statuses (calls renderItems with current items cached via onValue)
      // To ensure header statuses reflect new currentCategoryStatus, fetch current items and re-render
      get(itemsRef).then(s=> renderItems(s.val() || {})).catch(()=>{});
    });

    filterEl.addEventListener("change",async()=>{
      const snap=await get(itemsRef);
      renderItems(snap.val()||{});
    });

    saveBtn.addEventListener("click",async()=>{
      const name=nameEl.value.trim();
      const price=parseFloat(priceEl.value)||0;
      const category=categoryEl.value;
      const image=imageEl.value.trim();
      const addOns=parseAddons(addonsEl.value);
      if(!name){alert("Please enter name");return;}
      const payload={name,price:Number(price),category,image:image||null,addOns,visible:true};
      try{
        if(editingId){await update(ref(db,`menuItems/${editingId}`),payload); showNotice("Updated menu item");}
        else{const newRef=push(itemsRef); await set(newRef,payload); showNotice("Added new menu item");}
        resetForm();
      }catch(err){console.error(err); showNotice("Failed to save");}
    });

    resetBtn.addEventListener("click",(e)=>{e.preventDefault();resetForm();});
    deleteBtn.addEventListener("click",async()=>{
      if(!editingId) return;
      if(!confirm("Delete this menu item?")) return;
      try{await remove(ref(db,`menuItems/${editingId}`)); showNotice("Deleted"); resetForm();}
      catch(err){console.error(err); showNotice("Delete failed");}
    });

    // initialize
    resetForm();
  </script>
</body>
</html>
