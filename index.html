<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Restoran Ayam Gepuk Ngences ‚Äî Menu</title>

  <!-- Simple modern styles optimized for mobile -->
  <style>
:root {
  --accent: #007bff;
  --green: #28a745;
  --card-bg: #ffffff;
  --muted: #6b7280;
  --surface: #f7f9fc;
  --success-border: #c8f6c8;
}

html, body {
  height: 100%;
}
body {
  margin: 0;
  font-family: "Segoe UI", Roboto, system-ui, -apple-system, "Helvetica Neue", Arial;
  background: var(--surface);
  color: #111827;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  padding: 12px 12px 100px; /* bottom area for floating cart */
}

/* ===== Layout ===== */
.layout {
  display: flex;
  gap: 16px;
}

  /* ===== Sticky filter bar ===== */
.filter-container {
  position: sticky;   /* sticks inside its parent */
  top: 0;             /* stay at very top */
  z-index: 50;        /* above menu items */
  background: var(--surface); /* same background so it looks clean */
  padding: 10px 0;
  margin-bottom: 20px;
  display: flex;
  overflow-x: auto;
  gap: 10px;
  scrollbar-width: none;
}
.filter-container::-webkit-scrollbar {
  display: none;
}


  .filter-container label {
    flex: 0 0 auto;
    cursor: pointer;
  }
  .filter-chip {
    display: inline-block;
    padding: 8px 14px;
    border: 1px solid #ccc;
    border-radius: 25px;
    font-size: 14px;
    background: #fff;
    color: #444;
    transition: all 0.25s;
    white-space: nowrap;
  }
  .filter-container input[type="radio"] {
    display: none;
  }
  .filter-container input[type="radio"]:checked + .filter-chip {
    background: #007bff;
    border-color: #007bff;
    color: #fff;
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
  }

  /* Responsive tweaks */
  @media (max-width: 600px) {
    .filter-chip {
      font-size: 13px;
      padding: 7px 12px;
    }
  }
/* ===== Main ===== */
.main {
  flex: 1;
  min-width: 0; /* prevents overflow */
}

header {
  text-align: center;
  margin-bottom: 10px;
}
h1 {
  margin: 6px 0;
  font-size: 1.4rem;
  letter-spacing: -0.2px;
}
h2 {
  margin: 6px 0 12px;
  color: var(--muted);
  font-size: 0.95rem;
}

/* ===== Menu grid ===== */
#menu-list {
  margin-top: 12px;
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
  gap: 12px;
}


.menuItem {
  background: var(--card-bg);
  border-radius: 12px;
  padding: 12px;
  border: 1px solid #eef2f6;
  box-shadow: 0 4px 18px rgba(9, 30, 66, 0.03);
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.menuItem .top-row {
  display: flex;
  gap: 10px;
  align-items: center;
}
.menuItem img {
  width: 84px;
  height: 64px;
  object-fit: cover;
  border-radius: 8px;
  flex-shrink: 0;
  border: 1px solid #f0f2f5;
}
.menuItem .title {
  font-weight: 600;
  font-size: 15px;
  line-height: 1.1;
}
.menuItem .price {
  color: var(--muted);
  font-size: 13px;
  margin-top: 4px;
}
.menuItem .controls {
  display: flex;
  gap: 8px;
  align-items: center;
  margin-top: 4px;
  flex-wrap: wrap;
}
.menuItem .quantity {
  width: 64px;
  padding: 6px;
  border-radius: 8px;
  border: 1px solid #e6e9ee;
  font-size: 14px;
  text-align: center;
}

.addons-toggle {
  background: none;
  border: none;
  color: var(--accent);
  padding: 6px 0;
  cursor: pointer;
  font-size: 13px;
}
.add-ons {
  display: none;
  padding: 8px;
  border-radius: 8px;
  border: 1px dashed #e6e9ee;
  background: #fbfdff;
  gap: 6px;
  font-size: 13px;
  margin-top: 6px;
}
.add-ons label {
  display: block;
  margin: 4px 0;
}

.menuItem .add-btn {
  margin-top: 8px;
  background: var(--green);
  color: white;
  border: none;
  padding: 8px 10px;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
}
.menuItem .add-btn:active {
  transform: translateY(1px);
}

/* ===== Cart area ===== */
.cart {
  max-width: 1000px;
  margin: 22px auto;
  padding: 16px;
  border-radius: 12px;
  border: 2px solid var(--success-border);
  background: #f7fff8;
}
.cart h3 {
  margin: 0 0 8px 0;
  font-size: 1.05rem;
}
#cart-items {
  display: flex;
  flex-direction: column;
  gap: 8px;
  margin-top: 10px;
}
.cart-item-card {
  display: flex;
  gap: 12px;
  align-items: center;
  justify-content: space-between;
  padding: 10px;
  border-radius: 10px;
  background: white;
  border: 1px solid #eceff3;
}
.cart-item-left {
  display: flex;
  gap: 10px;
  align-items: center;
}
.cart-item-title {
  font-weight: 600;
  font-size: 14px;
}
.cart-item-addons {
  font-size: 12px;
  color: var(--muted);
}
.cart-controls {
  display: flex;
  gap: 6px;
  align-items: center;
}
.qty-btn {
  background: var(--accent);
  color: white;
  border: none;
  border-radius: 8px;
  padding: 6px 8px;
  cursor: pointer;
  font-weight: 700;
}
.remove {
  background: #ef4444;
  color: white;
  border: none;
  padding: 6px 8px;
  border-radius: 8px;
  cursor: pointer;
}

/* Cart footer layout */
.cart-footer {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  align-items: center;
  margin-top: 12px;
  width: 100%;
}

.cart-footer .inputs {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  flex: 1; /* grow to fit */
}

/* General inputs inside cart */
.cart-footer input[type="text"] {
  flex: 1;                 /* expand/shrink with space */
  min-width: 120px;        /* prevents being too small */
  max-width: 200px;        /* keeps name/table neat */
  padding: 8px;
  border-radius: 8px;
  border: 1px solid #e6e9ee;
}

/* Special Request box */
#special-request {
  flex: 1;                /* expand within container */
  min-width: 0;           /* allow shrinking */
  max-width: 100%;        /* never overflow */
  padding: 8px;
  border-radius: 8px;
  border: 1px solid #e6e9ee;
  box-sizing: border-box; /* include padding in width */
}


.submit-btn {
  background: var(--accent);
  color: white;
  padding: 10px 14px;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  font-weight: 700;
}

/* ===== Floating cart button ===== */
.cart-button {
  position: fixed;
  right: 14px;
  bottom: 14px;
  background: var(--accent);
  color: white;
  border: none;
  border-radius: 999px;
  padding: 12px 16px;
  box-shadow: 0 6px 18px rgba(2, 6, 23, 0.18);
  cursor: pointer;
  z-index: 40;
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: 700;
}
.cart-count {
  background: #ef4444;
  color: white;
  padding: 3px 8px;
  border-radius: 999px;
  font-size: 13px;
}

/* ===== Overlays ===== */
.overlay {
  position: fixed;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(0, 0, 0, 0.5);
  z-index: 9999;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.22s;
}
.overlay.show {
  opacity: 1;
  pointer-events: auto;
}
.overlay .panel {
  display: flex;
  flex-direction: column;
  gap: 12px;
  align-items: center;
  background: rgba(255, 255, 255, 0.06);
  color: white;
  padding: 20px;
  border-radius: 12px;
  backdrop-filter: blur(6px);
}
.spinner {
  width: 44px;
  height: 44px;
  border-radius: 999px;
  border: 4px solid rgba(255, 255, 255, 0.25);
  border-top-color: white;
  animation: spin 1s linear infinite;
}
@keyframes spin {
  to {
    transform: rotate(360deg);
  }
}

/* ===== Responsive adjustments ===== */
@media (max-width: 600px) {
  .sidebar {
    width: 120px;
    padding: 8px;
  }
  .filter-list label {
    font-size: 12px;
    padding: 6px 8px;
  }
  .menuItem img {
    width: 72px;
    height: 60px;
  }
  .cart-footer input[type="text"] {
    width: 130px;
  }
  #menu-list {
    gap: 10px;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
  }
}
/* Style for unavailable menu items */
/* Unavailable item base style */
.menuItem.unavailable {
  opacity: 0.7;
  filter: grayscale(20%);
  position: relative;
}

/* Top-right badge */
.menuItem.unavailable::before {
  content: "Not Available";
  position: absolute;
  top: 10px;
  right: 10px;
  background: #ef4444;
  color: #fff;
  font-size: 12px;
  font-weight: 600;
  padding: 3px 10px;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.15);
  text-transform: uppercase;
}
/* Cart footer layout */
.cart-footer {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  align-items: center;
  margin-top: 12px;
  width: 100%;
  box-sizing: border-box;
}

/* Input container */
.cart-footer .inputs {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  flex: 1; /* grow to fit */
  min-width: 0; /* prevent pushing beyond parent */
}

/* General inputs inside cart */
.cart-footer input[type="text"] {
  flex: 1;
  min-width: 120px;
  max-width: 100%;   /* never overflow */
  padding: 8px;
  border-radius: 8px;
  border: 1px solid #e6e9ee;
  box-sizing: border-box;
}

/* Special Request box */
#special-request {
  flex: 1 1 100%;    /* take full row if needed */
  min-width: 0;
  max-width: 100%;
  padding: 8px;
  border-radius: 8px;
  border: 1px solid #e6e9ee;
  box-sizing: border-box;
}

/* Cart item card */
.cart-item-card {
  display: flex;
  flex-direction: column; /* stack neatly on mobile */
  gap: 8px;
  padding: 10px;
  border-radius: 10px;
  background: white;
  border: 1px solid #eceff3;
  box-sizing: border-box;
  width: 100%;
  overflow-wrap: break-word;
  word-break: break-word;
}

/* Title and add-ons text */
.cart-item-title,
.cart-item-addons {
  max-width: 100%;
  white-space: normal; /* wrap text instead of overflow */
}

/* Controls + price row */
.cart-item-card > div:last-child {
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap; /* wrap buttons if needed */
  gap: 8px;
  width: 100%;
}




  </style>
</head>
<body>
  <div class="filter-container">
  <label>
    <input type="radio" name="filter" value="all" checked>
    <span class="filter-chip">üìã All</span>
  </label>
  <label>
    <input type="radio" name="filter" value="food">
    <span class="filter-chip">üçΩÔ∏è Food</span>
  </label>
  <label>
    <input type="radio" name="filter" value="Side Dish">
    <span class="filter-chip">üßÇ Side Dish</span>
  </label>
  <label>
    <input type="radio" name="filter" value="Air Panas">
    <span class="filter-chip">‚òï Air Panas</span>
  </label>
  <label>
    <input type="radio" name="filter" value="Air Sejuk">
    <span class="filter-chip">ü•§ Air Sejuk</span>
  </label>
  <label>
    <input type="radio" name="filter" value="Little Ngences Food">
    <span class="filter-chip">üç© Little Ngences Food</span>
  </label>
  <label>
    <input type="radio" name="filter" value="Little Ngences Drink">
    <span class="filter-chip">üßã Little Ngences Drink</span>
  </label>
</div>
  <!-- Main -->
  <div class="main">
    <header>
      <h1>üçΩÔ∏è Restoran Ayam Gepuk Ngences</h1>
      <h2>- Pilih menu & hantar pesanan -</h2>
    </header>


  <!-- menu list -->
  <main id="menu-list" aria-live="polite"></main>

  <!-- floating cart -->
  <button id="goToCartBtn" class="cart-button" aria-label="Open cart">üõí Cart <span id="cartCount" class="cart-count"></span></button>

  <!-- cart section -->
  <section class="cart" aria-labelledby="cart-title">
    <h3 id="cart-title">üõí My Cart</h3>
    <div id="cart-items"></div>

    <div style="margin-top:10px; display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap;">
      <div id="total-price" style="font-weight:700">Total: RM0.00</div>
      <div class="cart-footer">
        <div class="inputs">
          <input id="customer-name" type="text" placeholder="üë§ Name" required>
          <input id="table-number" type="text" placeholder="ü™ë Table No" required>
        </div>
        <input id="special-request" type="text" placeholder="‚úèÔ∏è Special Request" style="min-width:100px;">
        <button id="submit-button" class="submit-btn" onclick="submitOrder()">Submit Order</button>
      </div>
    </div>
  </section>

  <!-- overlays -->
  <div id="loading-overlay" class="overlay" aria-hidden="true">
    <div class="panel">
      <div class="spinner" role="status" aria-hidden="true"></div>
      <div style="font-weight:700">‚è≥ Submitting your order...</div>
      <div style="font-size:13px;color:rgba(255,255,255,0.85)">Please wait ‚Äî we're preparing it on our side.</div>
    </div>
  </div>

  <div id="success-overlay" class="overlay" aria-hidden="true">
    <div class="panel" style="background:rgba(40,167,69,0.12); color:#08310a;">
      <div style="font-size:22px; font-weight:800">üéâ Order Submitted</div>
      <div id="queue-number-text" style="font-size:20px; font-weight:700; color:#08310a"></div>
      <div style="font-size:13px; color:#06321f">You can download your receipt or wait for collection/serving.</div>
    </div>
  </div>

  <!-- success sound (optional) -->
  <audio id="success-sound" src="success.mp3" preload="auto"></audio>

  <!-- jsPDF (for receipt) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- Firebase + logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getDatabase, ref, onValue, push, get } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

    // ---------- FIREBASE CONFIG ----------
    const firebaseConfig = {
      apiKey: "AIzaSyAUO2ZoVhSFEtAyJAP5r5zxu3kGqoIAyQ4",
      authDomain: "ordersystem-d710a.firebaseapp.com",
      databaseURL: "https://ordersystem-d710a-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "ordersystem-d710a",
      storageBucket: "ordersystem-d710a.firebasestorage.app",
      messagingSenderId: "741444965493",
      appId: "1:741444965493:web:9991535a9105035c80943c",
      measurementId: "G-4P6YQDH0LL"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // ---------- State ----------
    const menuListEl = document.getElementById("menu-list");
    let cart = [];

    // ---------- Render single menu item ----------
function renderMenuItem(id, item) {
  let addonsHTML = "";
  if (item.addOns && typeof item.addOns === "object") {
    for (const k in item.addOns) {
      const label = String(k).replace(/_/g, " / ");
      const price = Number(item.addOns[k]) || 0;
      addonsHTML += `
        <label>
          <input type="checkbox" class="addon-checkbox" data-price="${price}" data-label="${label}" ${item.visible === false ? "disabled" : ""}>
          ${label} (+RM${price.toFixed(2)})
        </label>
      `;
    }
  }

  const isAvailable = item.visible !== false;

  return `
    <article class="menuItem ${isAvailable ? "" : "unavailable"}" 
             id="${id}" 
             data-price="${Number(item.price) || 0}" 
             data-name="${escapeHtml(item.name || "")}" 
             data-category="${escapeHtml(item.category || "")}">
             
      <div class="top-row">
        ${ item.image ? `<img src="${escapeHtml(item.image)}" alt="${escapeHtml(item.name || "")}">` : "" }
        <div style="flex:1">
          <div class="title">${escapeHtml(item.name || "Unnamed")}</div>
          <div class="price">RM ${Number(item.price || 0).toFixed(2)}</div>
        </div>
      </div>

      <div class="controls">
        <label style="font-size:13px; color:var(--muted)">Quantity</label>
        <input class="quantity" type="number" min="1" value="1" aria-label="Quantity for ${escapeHtml(item.name || "item")}" ${!isAvailable ? "disabled" : ""}>
        <button class="addons-toggle" onclick="toggleAddons(this)" ${!isAvailable ? "disabled" : ""}>+ Customize</button>
      </div>

      <div class="add-ons">${addonsHTML}</div>

      <button class="add-btn" onclick="addToCart(this)" ${!isAvailable ? "disabled" : ""}>
        ${isAvailable ? "Add to Cart" : "Not Available"}
      </button>
    </article>
  `;
}


    // small helper to avoid XSS when injecting strings
    function escapeHtml(str) {
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'", "&#39;");
    }

    

    // ---------- Load menu from Firebase ----------
    function loadMenuItems() {
      const menuRef = ref(db, "menuItems");
      onValue(menuRef, snapshot => {
        menuListEl.innerHTML = "";
        const items = snapshot.val() || {};
        // render in stable order if you stored numeric keys; otherwise iterate
        Object.keys(items).forEach(id => {
          try { menuListEl.insertAdjacentHTML("beforeend", renderMenuItem(id, items[id])); }
          catch(e){ console.error("Render item failed", id, e); }
        });
        applyFilter(document.querySelector('input[name="filter"]:checked')?.value || "all");
      }, err => {
        console.error("Failed to read menuItems:", err);
      });
    }
    loadMenuItems();

    // ---------- Toggle add-ons (global fn used in markup) ----------
    window.toggleAddons = function(button){
      const addons = button.parentElement.nextElementSibling;
      if(!addons) return;
      const isOpen = addons.style.display === "block";
      addons.style.display = isOpen ? "none" : "block";
      button.textContent = isOpen ? "+ Customize" : "- Hide Add-ons";
    };

    // ---------- Add to cart ----------
    window.addToCart = function(button) {
      const card = button.closest(".menuItem");
      if(!card) return;
      const name = card.dataset.name;
      const basePrice = Number(card.dataset.price) || 0;
      const qtyInput = card.querySelector(".quantity");
      const qty = Math.max(1, parseInt(qtyInput?.value||1));

      // compute add-ons selected
      const addOnEls = card.querySelectorAll(".addon-checkbox:checked");
      let addonNames = [];
      let addonExtra = 0;
      addOnEls.forEach(el => {
        const price = Number(el.dataset.price)||0;
        const label = el.dataset.label || "(addon)";
        addonNames.push(label);
        addonExtra += price;
      });

      // Store item price per unit including add-ons
      const unitPrice = basePrice + addonExtra;

      cart.push({ item: name, price: unitPrice, quantity: qty, addOns: addonNames });
      updateCartView();
      updateCartCount();

      // small UI feedback (brief)
      button.textContent = "Added ‚úì";
      button.disabled = true;
      setTimeout(()=>{ button.textContent = "Add to Cart"; button.disabled = false; }, 900);
    };

    // ---------- Cart render & functions ----------
    function updateCartView(){
      const el = document.getElementById("cart-items");
      el.innerHTML = "";
      let total = 0;
      cart.forEach((row, idx) => {
        const rowTotal = (row.price * row.quantity) || 0;
        total += rowTotal;
        el.insertAdjacentHTML("beforeend", `
          <div class="cart-item-card" data-index="${idx}">
            <div class="cart-item-left">
              <div>
                <div class="cart-item-title">${escapeHtml(row.item)}</div>
                <div class="cart-item-addons">${row.addOns.length ? escapeHtml(row.addOns.join(", ")) : '<span style="color:var(--muted)">No add-ons</span>'}</div>
              </div>
            </div>

            <div style="display:flex; align-items:center; gap:10px;">
              <div class="cart-controls" aria-hidden="true">
                <button class="qty-btn" onclick="changeQty(${idx}, -1)">‚àí</button>
                <div style="min-width:26px; text-align:center;">${row.quantity}</div>
                <button class="qty-btn" onclick="changeQty(${idx}, 1)">+</button>
              </div>
              <div style="min-width:80px; text-align:right; font-weight:700">RM ${rowTotal.toFixed(2)}</div>
              <button class="remove" onclick="removeFromCart(${idx})" aria-label="Remove item">‚ùå</button>
            </div>
          </div>
        `);
      });

      document.getElementById("total-price").textContent = "Total: RM " + total.toFixed(2);
    }

    window.changeQty = function(index, delta) {
      if (!cart[index]) return;
      cart[index].quantity += delta;
      if (cart[index].quantity <= 0) cart.splice(index,1);
      updateCartView(); updateCartCount();
    };

    window.removeFromCart = function(index){
      if (!cart[index]) return;
      cart.splice(index,1);
      updateCartView(); updateCartCount();
    };

    function updateCartCount(){
      const totalItems = cart.reduce((s,i) => s + (i.quantity||0), 0);
      document.getElementById("cartCount").textContent = totalItems > 0 ? totalItems : "";
    }

   // ---------- Filter behavior ----------
function applyFilter(cat){
  document.querySelectorAll(".menuItem").forEach(item => {
    const category = (item.dataset.category||"").trim();

    // Exclude Little Ngences categories from "all"
    if(cat === "all"){
      if(category === "Little Ngences Food" || category === "Little Ngences Drink"){
        item.style.display = "none";
      } else {
        item.style.display = "";
      }
    } else {
      item.style.display = (category === cat) ? "" : "none";
    }
  });
}

// Attach listener
document.querySelectorAll('input[name="filter"]').forEach(radio=>{
  radio.addEventListener("change", e => applyFilter(e.target.value));
});

// Apply default filter on load
applyFilter("all");


    // ---------- Queue helpers ----------
    async function getLastQueueNumber(){
      try {
        const ordersRef = ref(db, "orders");
        const snap = await get(ordersRef);
        if (!snap.exists()) return 6999;
        const obj = snap.val();
        const nums = Object.values(obj).map(o => Number(o.queueNumber)).filter(n => !isNaN(n));
        if (nums.length === 0) return 6999;
        return Math.max(...nums);
      } catch(err) {
        console.error("getLastQueueNumber error", err);
        return 6999;
      }
    }

    function loadLogoAndGenerate(orderDetails) {
  fetch("logo.png") // ‚úÖ ensure correct relative path
    .then(res => res.blob())
    .then(blob => {
      const reader = new FileReader();
      reader.onload = function(e) {
        const logoBase64 = e.target.result;
        generateReceiptPDF(orderDetails, logoBase64);
      };
      reader.readAsDataURL(blob);
    })
    .catch(err => {
      console.error("Error loading logo:", err);
      generateReceiptPDF(orderDetails, null); // fallback without logo
    });
}

    // ---------- Receipt (PDF) ----------
function generateReceiptPDF(orderDetails) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  let y = 20;

  // üè™ Header text
  doc.setFont("helvetica", "bold");
  doc.setFontSize(16);
  doc.text("Restoran Ayam Gepuk Ngences", 105, y, { align: "center" });
  y += 8;
  doc.setFontSize(11);
  doc.setFont("helvetica", "normal");
  doc.text("39, Laluan BG Transit 2, Kampung Bendera,", 105, y, { align: "center" });
  y += 6;
  doc.text("30200 Batu Gajah, Perak", 105, y, { align: "center" });

  // Divider
  y += 8;
  doc.line(20, y, 190, y);
  y += 10;

  // üìå Order Info
  const orderDate = new Date(orderDetails.timestamp).toLocaleString();
  doc.setFont("helvetica", "normal");
  doc.text(`Order No: ${orderDetails.queueNumber}`, 20, y); y += 6;
  doc.text(`Name: ${orderDetails.name}`, 20, y); y += 6;
  doc.text(`Table: ${orderDetails.table}`, 20, y); y += 6;
  doc.text(`Special Request: ${orderDetails.request || "None"}`, 20, y); y += 6;
  doc.text(`Date: ${orderDate}`, 20, y);

  // Divider
  y += 8;
  doc.line(20, y, 190, y);
  y += 10;

  // üìÇ Group items by category
  const grouped = {};
  orderDetails.cart.forEach(item => {
    const category = item.category || "Others";
    if (!grouped[category]) grouped[category] = [];
    grouped[category].push(item);
  });

  const categoryOrder = [
    "food", "Side Dish", "Air Panas", "Air Sejuk",
    "Little Ngences Food", "Little Ngences Drink", "Others"
  ];

  // Table Layout
  doc.setFont("helvetica", "bold");
  doc.setFontSize(12);

  categoryOrder.forEach(category => {
    if (grouped[category]) {
      // Section Title
      doc.text(category.toUpperCase(), 20, y);
      y += 8;

      // Table Header
      doc.setFontSize(11);
      doc.text("Item", 20, y);
      doc.text("Qty", 120, y, { align: "right" });
      doc.text("Price (RM)", 190, y, { align: "right" });
      y += 6;

      doc.setLineWidth(0.2);
      doc.line(20, y, 190, y);
      y += 6;

      // Items
      grouped[category].forEach(item => {
        const addOns = item.addOns.length ? ` [${item.addOns.join(", ")}]` : "";
        doc.setFont("helvetica", "normal");

        // Long item names wrap
        let itemText = `${item.item}${addOns}`;
        let splitText = doc.splitTextToSize(itemText, 90); // wrap long names

        splitText.forEach((line, index) => {
          doc.text(line, 20, y);
          if (index === 0) {
            doc.text(`${item.quantity}`, 120, y, { align: "right" });
            doc.text(`${(item.price * item.quantity).toFixed(2)}`, 190, y, { align: "right" });
          }
          y += 6;
        });
      });

      y += 8; // space between groups
    }
  });

  // Divider
  doc.line(20, y, 190, y);
  y += 10;

  // üí∞ Total
  doc.setFont("helvetica", "bold");
  doc.setFontSize(13);
  doc.text(`TOTAL: RM ${orderDetails.totalPrice.toFixed(2)}`, 190, y, { align: "right" });
  y += 15;

  // Footer
  doc.setFont("helvetica", "italic");
  doc.setFontSize(11);
  doc.text("‚úÖ Thank you for dining with us!", 105, y, { align: "center" });
  y += 8;
  doc.text("Ayam Gepuk Ngences x Ngences Coffee", 105, y, { align: "center" });
  y += 8;

  // Programmer Credit
  doc.setFont("courier", "normal");
  doc.setFontSize(10);
  doc.text("System developed by: Muhammad Asyraf (Programmer)", 105, y, { align: "center" });

  // Save file
  doc.save(`Receipt_${orderDetails.queueNumber}.pdf`);
}


    // ---------- Submit order ----------
    async function submitOrder(){
      const submitBtn = document.getElementById("submit-button");
      const loadingOverlay = document.getElementById("loading-overlay");
      const successOverlay = document.getElementById("success-overlay");
      const queueText = document.getElementById("queue-number-text");

      // UI prepare
      submitBtn.disabled = true;
      submitBtn.innerText = "Submitting...";
      loadingOverlay.classList.add("show");

      const name = (document.getElementById("customer-name").value||"").trim();
      const table = (document.getElementById("table-number").value||"").trim();
      const request = (document.getElementById("special-request").value||"").trim();

      if (!name || !table || cart.length === 0) {
        alert("Sila lengkapkan nama, nombor meja dan tambahkan sekurang-kurangnya 1 item ke troli.");
        submitBtn.disabled = false;
        submitBtn.innerText = "Submit Order";
        loadingOverlay.classList.remove("show");
        return;
      }

      try {
        const last = await getLastQueueNumber();
        const queueNumber = (Number(last) || 6999) + 1;
        const totalPrice = cart.reduce((s,i)=> s + (i.price * i.quantity), 0);

        const orderDetails = {
          queueNumber,
          name,
          table,
          request,
          cart,
          totalPrice,
          timestamp: new Date().toISOString()
        };

        // push to firebase
        await push(ref(db, "orders"), orderDetails);

        // success UI
        cart = [];
        updateCartView(); updateCartCount();

        loadingOverlay.classList.remove("show");
        queueText.textContent = `Queue # ${queueNumber}`;
        successOverlay.classList.add("show");
        document.getElementById("success-sound")?.play?.();

        // ask to download receipt
        setTimeout(() => {
          const download = confirm(`‚úÖ Order placed!\nYour Queue No: ${queueNumber}\n\nDownload receipt now?`);
          if (download) generateReceiptPDF(orderDetails);
        }, 500);

        // hide success overlay after some seconds
        setTimeout(()=> successOverlay.classList.remove("show"), 4500);

      } catch (err) {
        console.error("submitOrder failed", err);
        alert("Gagal menghantar pesanan. Sila cuba lagi.");
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerText = "Submit Order";
        loadingOverlay.classList.remove("show");
      }
    }

    // expose to window (so existing onclick=submitOrder() works)
    window.submitOrder = submitOrder;

    // ---------- small helpers ----------
    // update cart count immediately on load
    updateCartCount();

    // small accessibility: clicking floating cart scrolls to cart
    document.getElementById("goToCartBtn").addEventListener("click", ()=> {
      document.querySelector(".cart").scrollIntoView({ behavior: "smooth" });
    });

    // close overlays on background click (success only)
    document.getElementById("success-overlay").addEventListener("click", (e)=> {
      if (e.currentTarget === e.target) e.currentTarget.classList.remove("show");
    });

    // ensure filter applied on page load (menu is loaded async)
    document.addEventListener("click", (e) => {
      if (e.target.matches(".filter-chip, .filter-chip *")) {
        // nothing: change handled by input radio change
      }
    });

  </script>
</body>
</html>
